<?xml version="1.0" encoding="UTF-8"?>
<site site="http://mlb.mlb.com"
    plugin="http://mlb.mlb.com/flash/mediaplayer/v4.2/R2/MediaPlayer4.swf"
    identifier="com.plexapp.plugins.harleyball"
    initialState="wait-for-frame-load"
	version="1.0">

	<crop x="0" y="102" width="800" height="450" />

	<!-- The condition we use several times from within states to check if we're logged in or not -->
	<condition name="need-to-login">
		<and>
            
			<!-- Return true if we're logged in -->
			<javascript script="login = $('a.loggedOut').length == 1 ? 1 : 0" matches="1" />
		</and>
	</condition>
    
    <condition name="no-login">
		<and>
            
			<!-- Return true if we're logged in -->
			<javascript script="login = $('a.loggedIn').length == 1 ? 1 : 0" matches="1" />
		</and>
	</condition>

	<state name="wait-for-frame-load">
		<event>
			<condition>
				<!-- Wait for the DOM to load... -->
				<frameLoaded />
			</condition>
			<action>
                <pause time="1000" />
                <!-- Visit this page to check if logged in -->
                <visit url="https://secure.mlb.com/account/topNavLogin.jsp" />
                <!--let the page load -->
                <!-- ...then goto the 'check-for-auth' state -->
				<goto state="pre-auth" />
			</action>
		</event>
	</state>

 	<state name="pre-auth">
		<event>
			<condition>
				<!-- Wait for the DOM to load... -->
				<javascript script="login = $('body').length == 1 ? 1 : 0" matches="1" />
			</condition>
			<action>
				<goto state="logcheck" />
			</action>
		</event>
	</state>
    
    <state name="pre-check">
		<event>
			<condition>
				<!-- Wait for the DOM to load... -->
				<javascript script="title = $('title').text = 'Login Success' ? 1 : 0" matches="1" />
			</condition>
			<action>
				<goto state="recheck" />
			</action>
		</event>
		<event>
			<condition>
				<!-- Wait for the DOM to load... -->
                <not>
                    <javascript script="title = $('title').text == 'Login Success' ? 1 : 0" matches="1" />
                </not>
            </condition>
			<action>
				<goto state="pre-check" />
			</action>
		</event>
	</state>
    
	<state name="logcheck">
		<event>
			<condition>
				<!-- If we don't need to login, goto state 'playing' -->
				<condition name="no-login" />
			</condition>
			<action>
				<goto state="playing" />
			</action>
		</event>
		<event>
			<!-- If we *do* need to login, fill in the form and post it -->
			<condition>
                <and>
                    <condition name="need-to-login" />
                </and>
            </condition>
			<action>
                <run script="var post_url='https://secure.mlb.com/account/topNavLogin.jsp';var post_data={emailAddress:'${mlb_user}',password:'${mlb_pass}', successRedirect:'http://mlb.mlb.com/shared/account/v2/login_success.jsp%3Fcallback%3Dl1300638004681',errorRedirect:'http://mlb.mlb.com/account/quick_login_hdr.jsp?error=true&amp;successRedirect=http%3A%2F%2Fmlb.mlb.com%2Fshared%2Faccount%2Fv2%2Flogin_success.jsp%253Fcallback%253Dl1300638004681&amp;callback=l1300638004681&amp;stylesheet=%2Fstyle%2Faccount_management%2FmyAccountMini.css&amp;submitImage=%2Fshared%2Fcomponents%2Fgameday%2Fv4%2Fimages%2Fbtn-login.gif',login:'1'};jQuery.post(post_url,post_data);" />
                <goto state="pre-check" />
			</action>
		</event>
	</state>
    
    <state name="recheck">
		<event>
			<condition>
				<!-- If we don't need to login, goto state 'playing' -->
				<condition name="no-login" />
			</condition>
			<action>
				<goto state="playing" />
			</action>
		</event>
		<event>
			<!-- If we *do* need to login, fill in the form and post it -->
			<condition>
                <and>
                    <condition name="need-to-login" />
                </and>
            </condition>
			<action>
                <goto state="end" param="Please check your username and password." />
			</action>
		</event>
	</state>

    <state name="playing">
        <!-- showing the login form -->




        <!-- message: hd alert -->
        <event>
            <condition>
                <and>
                    <javascript script="login = $('html').length == 1 ? 1 : 0" matches="1" />
                </and>
            </condition>
            <action>
                <goto state="playing"/>
            </action>
        </event>

        <!-- pause button -->
        <event>
            <condition>
                <command name="pause"/>
            </condition>
            <action>
                <move x="396" y="510"/>
                <pause time="500"/>
                <click x="396" y="510"/>
                <move x="0" y="0"/>
                <goto state="paused"/>
            </action>
        </event>
    </state>

    <!-- paused -->
    <state name="paused">
        <!-- play button -->
        <event>
            <condition>
                <command name="play"/>
            </condition>
            <action>
                <move x="396" y="510"/>
                <pause time="500"/>
                <click x="396" y="510"/>
                <move x="0" y="0"/>

                <goto state="playing"/>
            </action>
        </event>
    </state>
</site>