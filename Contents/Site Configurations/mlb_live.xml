<?xml version="1.0" encoding="UTF-8"?>
<site site="http://.*mlb\.com"
	    plugin="http://.*mlb\.com.*player.*\.swf"
    identifier="com.plexapp.plugins.harleyball"
    initialState="wait-for-frame-load"
	version="1.0" manualLock="true" >

	<crop x="0" y="102" width="800" height="450" />

	<!-- The condition we use several times from within states to check if we're logged in or not -->
	<condition name="need-to-login">
		<and>
            
			<!-- Return true if we're logged in -->
			<javascript script="login = $('a.loggedOut').length == 1 ? 1 : 0" matches="1" />
		</and>
	</condition>
    
    <condition name="no-login">
		<and>
            
			<!-- Return true if we're logged in -->
			<javascript script="login = $('a.loggedIn').length == 1 ? 1 : 0" matches="1" />
		</and>
	</condition>

	<state name="wait-for-frame-load">
		<event>
			<condition>
                <frameLoaded />
			</condition>
			<action>
                <pause time="1000" />
                <visit url="http://mlb.com/index.jsp/enterworkflow.do?flowId=registration.ajax.wizard&amp;c_id=mlb" />
                <goto state="logcheck" />
			</action>
		</event>
	</state>

 	<state name="pre-auth">
		<event>
			<condition>
				<!-- Wait for the DOM to load... -->
				<condition name="need-to-login" />
			</condition>
			<action>
				<goto state="logcheck" />
			</action>
		</event>
	</state>
    
    <state name="pre-play">
		<event>
			<condition>
				<!-- Wait for the DOM to load... -->
				<javascript script="true ? 1 : 0" matches="1" />
			</condition>
			<action>
                <visit url="${url}" />
				<goto state="pre-load" />
			</action>
		</event>
	</state>
    
    <state name="pre-load">
        <event>
            <condition>
                <javascript script="true ? 1 : 0" matches="1" />
            </condition>
			<action>
                <lockPlugin/>
                <goto state="playing" />
			</action>
		</event>
	</state>
    
    <state name="pre-check">
		<event>
			<condition>
				<!-- Wait for the DOM to load... -->
				<javascript script="title = $('title').text = 'Login Success' ? 1 : 0" matches="1" />
			</condition>
			<action>
                <pause time="500" />
            </action>
		</event>
		<event>
			<condition>
				<!-- Wait for the DOM to load... -->
                <not>
                    <javascript script="title = $('title').text == 'Login Success' ? 1 : 0" matches="1" />
                </not>
            </condition>
			<action>
				<goto state="pre-check" />
			</action>
		</event>
	</state>
    
	<state name="logcheck">
		<event>
            <condition>
				<and>
                    <condition name="no-login" />
				</and>
			</condition>
			<action>
                <goto state="pre-play" />
            </action>
        </event>
		<event>
			<!-- If we *do* need to login, fill in the form and post it -->
			<condition>
                <and>
                    <condition name="need-to-login" />
                </and>
            </condition>
			<action>
                <run script="var post_url='https://secure.mlb.com/account/topNavLogin.jsp';var post_data={emailAddress:'${mlb_user}',password:'${mlb_pass}', successRedirect:'http://mlb.mlb.com/shared/account/v2/login_success.jsp%3Fcallback%3Dl1300638004681',errorRedirect:'http://mlb.mlb.com/account/quick_login_hdr.jsp?error=true&amp;successRedirect=http%3A%2F%2Fmlb.mlb.com%2Fshared%2Faccount%2Fv2%2Flogin_success.jsp%253Fcallback%253Dl1300638004681&amp;callback=l1300638004681&amp;stylesheet=%2Fstyle%2Faccount_management%2FmyAccountMini.css&amp;submitImage=%2Fshared%2Fcomponents%2Fgameday%2Fv4%2Fimages%2Fbtn-login.gif',login:'1'};jQuery.post(post_url,post_data);" />
                <goto state="pre-check" />
			</action>
		</event>
	</state>
    
    <state name="recheck">
		<event>
			<condition>
				<!-- If we don't need to login, goto state 'playing' -->
				<condition name="no-login" />
			</condition>
			<action>
				<goto state="playing" />
			</action>
		</event>
		<event>
			<!-- If we *do* need to login, fill in the form and post it -->
			<condition>
                <and>
                    <condition name="need-to-login" />
                </and>
            </condition>
			<action>
                <goto state="end" param="Please check your username and password." />
			</action>
		</event>
	</state>

    <state name="playing">
        <event>
            <condition>
                <command name="pause" />
            </condition>
            <action>
                <click x="36" y="370" />
                <goto state="paused" />
            </action>
        </event>
    </state>
        
        <!-- PAUSED -->
    <state name="paused">
        <event>
            <condition>
                <command name="play" />
            </condition>
            <action>
                <click x="36" y="370" />
                <goto state="playing" />
            </action>
        </event>
    </state>

</site>